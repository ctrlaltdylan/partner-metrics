<%= polaris_page(
  title: t(".#{controller_name}.title"),
  subtitle: ""
) do |page| %>

  <%= turbo_frame_tag :metrics do %>

    <%= polaris_vertical_stack(gap: "5") do %>

      <%= render "filters",
        selected_chart: @selected_chart,
        selected_app: @selected_app,
        app_titles: @app_titles,
        date: @selected_or_latest_date,
        period: @period
      %>

      <% if @metrics.any? %>

          <%= render "selected_chart",
            selected_chart: @selected_chart,
            selected_app: @selected_app,
            metrics: @metrics,
            previous_metrics: @previous_metrics,
            date: @selected_or_latest_date,
            period: @period
          %>

          <%= polaris_horizontal_grid(gap: "5", columns: 3) do %>
            <% @tiles.each do |tile|%>
              <%= render "metric_tile",
                tile: tile,
                chart_url: metric_chart_url(tile["type"], @selected_or_latest_date, @period, @selected_app),
                selected_app: @selected_app,
                metrics: @metrics,
                previous_metrics: @previous_metrics,
                date: @selected_or_latest_date,
                period: @period
              %>
            <% end %>
          <% end %>

          <%= render "#{params[:controller]}/revenue_per",
            date: @selected_or_latest_date,
            selected_app: @selected_app,
            period: @period
          %>

      <% else %>

        <%= render "metrics/empty_state", heading: t(".#{controller_name}.title"), icon_name: "AnalyticsMajor" %>

      <% end %>

    <% end %>

    <%= polaris_card do %>
      <%= turbo_frame_tag current_user do %>
        <%= form_with(
          model: current_user,
          builder: Polaris::FormBuilder,
        ) do |form| %>

          <%= polaris_form_layout do |form_layout| %>

            <% if current_user.errors.any? %>
              <% form_layout.item do %>
                <%= form.errors_summary %>
              <% end %>
            <% end %>

            <% form_layout.with_item do %>
              <%= form.file_field :import_file, required: current_user.metrics.none? %>
            <% end %>

            <% form_layout.with_item do %>
              <%= polaris_button(
                submit: true,
                primary: true,
                data: {form_target: "submitButton"},
              ) { "Save" } %>
            <% end %>

          <% end %>

        <% end %>
      <% end %>
    <% end %>

  <% end %>

<% end %>
