<% current_value = metrics.calculate_value(current_user, selected_chart) %>
<% current_change = metrics.calculate_change(current_user, selected_chart, previous_metrics) %>

<%= polaris_card(title: selected_chart["title"]) do |card| %>

  <%= polaris_vertical_stack(gap: "5") do %>

    <%= polaris_stack(alignment: :center) do |stack| %>

      <% stack.with_item(fill: true) do %>
        <%= polaris_text(variant: :heading4xl, as: :h2) do %>
          <%= metric_display_value(selected_chart["display"], current_value)%>
        <% end %>
      <% end %>

      <% stack.with_item do %>
          <%= polaris_text(variant: :headingLg, as: :h3, color: metric_change_color(current_change, selected_chart["direction_good"])) do %>
            <%= number_to_percentage_with_precision(current_change) %>
          <% end %>
          <%= polaris_text(variant: :bodyMd, alignment: :end, color: :subdued) do %><%= pluralize(q[:period], 'day') %> ago<% end %>
      <% end %>

    <% end %>

    <%= area_chart(
      current_user.metrics.get_chart_data(
        selected_chart,
        q[:date],
        q[:period],
        q[:app]
      ),
      **metrics_chart_options
    )%>

    <%= polaris_divider %>

    <%= polaris_stack(distribution: :fill_evenly) do |stack| %>

      <% if show_averages(q[:period], q[:chart]) %>
        <% stack.with_item do %>
            <%= polaris_text(variant: :bodyMd, as: :h4, color: :subdued) do %>
              Daily Avg
            <% end %>
            <%= polaris_text(variant: :headingMd) do %>
              <% value = current_value / q[:period] * 1 %>
              <%= metric_display_value(selected_chart["display"], value)%>
            <% end %>
        <% end %>
      <% end %>

      <% periods_ago(q[:period]).each do |period_ago| %>
        <% stack.with_item do %>

          <%# TODO: Where to put these? %>
          <% value = Metric.calculate_value_period_ago(current_user, period_ago, q[:date], q[:period], selected_chart, q[:app]) || 0 %>
          <% change = value == 0 ? 0 : (current_value.to_f / value * 100) - 100 %>

          <%= polaris_text(variant: :bodyMd, as: :h4, color: :subdued) do %>
            <%= period_ago_in_words(q[:date], q[:period], period_ago) %>
          <% end %>

          <%= polaris_text(variant: :headingLg) do %>
            <%= metric_display_value(selected_chart["display"], value)%>
          <% end %>

          <%= polaris_text(variant: :headingSm, color: metric_change_color(change, selected_chart["direction_good"])) do %>
            <%= number_to_percentage_with_precision(current_change) %>
          <% end %>

        <% end %>
      <% end %>

    <% end %>

  <% end %>

<% end %>
