<%= polaris_page(
  title: t(".#{controller_name}.title"),
  subtitle: t(".#{controller_name}.subtitle"),
) do |page| %>

  <%= turbo_frame_tag :metrics do %>

    <%= polaris_vertical_stack(gap: "5") do %>

      <%= render "filters", q: current_query %>

      <% if @metrics.any? %>

          <%= render "selected_chart",
            q: current_query,
            selected_chart: select_chart(current_tiles, current_query[:chart]),
            metrics: @metrics,
            previous_metrics: @previous_metrics %>

          <%= polaris_horizontal_grid(gap: "5", columns: 3) do %>
            <% current_tiles.each do |tile|%>
              <%= render "metric_tile",
                q: current_query,
                tile: tile,
                metrics: @metrics,
                previous_metrics: @previous_metrics,
                chart_url: url_for(action: action_name, q: current_query.merge(chart: tile["type"])) %>
            <% end %>
          <% end %>

          <%= render "#{params[:controller]}/revenue_per", q: current_query %>

      <% else %>

        <%= render "metrics/empty_state", heading: t(".#{controller_name}.title"), icon_name: "AnalyticsMajor" %>

      <% end %>

    <% end %>

    <%= polaris_card do %>
      <%= turbo_frame_tag current_user do %>
        <%= form_with(
          model: current_user,
          builder: Polaris::FormBuilder,
        ) do |form| %>

          <%= polaris_form_layout do |form_layout| %>

            <% if current_user.errors.any? %>
              <% form_layout.item do %>
                <%= form.errors_summary %>
              <% end %>
            <% end %>

            <% form_layout.with_item do %>
              <%= form.file_field :import_file, required: current_user.metrics.none? %>
            <% end %>

            <% form_layout.with_item do %>
              <%= polaris_button(
                submit: true,
                primary: true,
                data: {form_target: "submitButton"},
              ) { "Save" } %>
            <% end %>

          <% end %>

        <% end %>
      <% end %>
    <% end %>

  <% end %>

<% end %>
