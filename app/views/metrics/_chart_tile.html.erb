<% current_value = metrics.calculate_value(current_user, chart_tile) %>
<% current_change = metrics.calculate_change(current_user, chart_tile, previous_metrics) %>

<%= polaris_card(title: chart_tile["title"]) do |card| %>

  <%= polaris_vertical_stack(gap: "5") do %>

    <%= polaris_stack do |stack| %>

      <% stack.with_item(fill: true) do %>
        <%= polaris_text(variant: :heading3xl, as: :h2) do %>
          <%= chart_tile_display_value(chart_tile["display"], current_value)%>
        <% end %>
      <% end %>

      <% stack.with_item do %>
          <%= polaris_text(variant: :headingLg, as: :h3, color: metric_change_color(current_change, chart_tile["direction_good"])) do %>
            <%= number_to_percentage_with_precision(current_change) %>
          <% end %>
          <%= polaris_text(variant: :bodyMd, alignment: :end, color: :subdued) do %><%= pluralize(period, 'day') %> ago<% end %>
      <% end %>

    <% end %>

    <%= area_chart metrics_charts_path(date: date, period: period, chart_type: chart_tile, app_title: app_title), **metrics_chart_options %>

    <%= polaris_divider %>

    <%= polaris_stack(distribution: :fill_evenly) do |stack| %>

      <% if show_averages(period, chart_tile) %>
        <% stack.with_item do %>
            <%= polaris_text(variant: :bodyMd, as: :h4, color: :subdued) do %>
              Daily Avg
            <% end %>
            <%= polaris_text(variant: :headingMd) do %>
              <% value = current_value / period * 1 %>
              <%= chart_tile_display_value(chart_tile["display"], value)%>
            <% end %>
        <% end %>
      <% end %>

      <% periods_ago(period).each do |period_ago| %>
        <% stack.with_item do %>

          <%# TODO: Where to put these? %>
          <% value = Metric.calculate_value_period_ago(current_user, period_ago, date, period, chart_tile, app_title) || 0 %>
          <% change = value == 0 ? 0 : (current_value.to_f / value * 100) - 100 %>

          <%= polaris_text(variant: :bodyMd, as: :h4, color: :subdued) do %>
            <%= period_ago_in_words(date, period, period_ago) %>
          <% end %>

          <%= polaris_text(variant: :headingLg) do %>
            <%= chart_tile_display_value(chart_tile["display"], value)%>
          <% end %>

          <%= polaris_text(variant: :headingSm, color: metric_change_color(change, chart_tile["direction_good"])) do %>
            <%= number_to_percentage_with_precision(current_change) %>
          <% end %>

        <% end %>
      <% end %>

    <% end %>

  <% end %>

<% end %>
